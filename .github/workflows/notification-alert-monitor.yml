name: Notification Alert Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Send external alerts when false"
        required: false
        type: choice
        options: ["true", "false"]
        default: "true"
      metrics_url:
        description: "Metrics endpoint URL override"
        required: false
        type: string
      test_payload:
        description: "Optional JSON payload to bypass metrics fetch"
        required: false
        type: string
      lag_warn_threshold:
        description: "Lag warning threshold override"
        required: false
        type: string
      lag_critical_threshold:
        description: "Lag critical threshold override"
        required: false
        type: string
      malformed_lag_warn_threshold:
        description: "Malformed lag warning threshold override"
        required: false
        type: string
      malformed_lag_critical_threshold:
        description: "Malformed lag critical threshold override"
        required: false
        type: string
      failed_warn_threshold:
        description: "Failed tasks warning threshold override"
        required: false
        type: string
      dlq_warn_threshold:
        description: "DLQ tasks warning threshold override"
        required: false
        type: string

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run alert monitor
        env:
          NOTIFICATION_METRICS_URL: ${{ secrets.NOTIFICATION_METRICS_URL }}
          NOTIFICATION_ALERT_SLACK_WEBHOOK: ${{ secrets.NOTIFICATION_ALERT_SLACK_WEBHOOK }}
          NOTIFICATION_ALERT_PAGERDUTY_KEY: ${{ secrets.NOTIFICATION_ALERT_PAGERDUTY_KEY }}
          ALERT_DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'false' }}
          ALERT_TEST_PAYLOAD: ${{ github.event_name == 'workflow_dispatch' && inputs.test_payload || '' }}
          LAG_WARN_THRESHOLD: ${{ github.event_name == 'workflow_dispatch' && inputs.lag_warn_threshold || '100' }}
          LAG_CRITICAL_THRESHOLD: ${{ github.event_name == 'workflow_dispatch' && inputs.lag_critical_threshold || '1000' }}
          MALFORMED_LAG_WARN_THRESHOLD: ${{ github.event_name == 'workflow_dispatch' && inputs.malformed_lag_warn_threshold || '20' }}
          MALFORMED_LAG_CRITICAL_THRESHOLD: ${{ github.event_name == 'workflow_dispatch' && inputs.malformed_lag_critical_threshold || '100' }}
          FAILED_WARN_THRESHOLD: ${{ github.event_name == 'workflow_dispatch' && inputs.failed_warn_threshold || '200' }}
          DLQ_WARN_THRESHOLD: ${{ github.event_name == 'workflow_dispatch' && inputs.dlq_warn_threshold || '100' }}
        run: |
          chmod +x scripts/*.sh
          URL="${NOTIFICATION_METRICS_URL:-}"
          MANUAL_URL="${{ github.event_name == 'workflow_dispatch' && inputs.metrics_url || '' }}"
          if [ -n "$MANUAL_URL" ]; then
            URL="$MANUAL_URL"
          fi

          if [ -z "$URL" ] && [ -z "$ALERT_TEST_PAYLOAD" ]; then
            echo "[monitor] skipped: NOTIFICATION_METRICS_URL (or metrics_url input) is not set"
            exit 0
          fi

          ./scripts/run_alert_monitor.sh "$URL"
