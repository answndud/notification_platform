# Chapter 18 - 복제와 Sentinel

- 상태: 초안 완료
- 목표 분량: 11쪽

## 학습 목표

- Redis 복제 구조(primary-replica)를 이해한다.
- Sentinel의 장애 감지/자동 전환 역할을 설명할 수 있다.
- 고가용성 구성 시 운영 체크포인트를 정리할 수 있다.

## 핵심 개념

복제는 읽기 확장과 가용성 향상을 위한 기본 전략입니다.
Primary 장애 시 Sentinel이 새 Primary 선출을 돕습니다.

Redis 복제는 기본적으로 비동기(asynchronous)입니다.
즉, Primary에 쓰기 성공 응답이 갔더라도
Replica까지 즉시 동일 상태가 된다고 보장할 수는 없습니다.

이 특성 때문에 장애 전환 시점에는
아주 최근 쓰기 데이터 일부가 유실될 수 있습니다.
그래서 "고가용성"과 "무손실"을 같은 의미로 보면 안 됩니다.

Sentinel 핵심 역할:

- 장애 감지
- 리더 합의
- failover 실행
- 클라이언트에 새 primary 정보 제공

### Sentinel 동작을 이해하는 최소 용어

- SDOWN(subjectively down): 개별 Sentinel이 장애라고 판단한 상태
- ODOWN(objectively down): 다수 Sentinel 합의로 장애 확정
- Quorum: ODOWN 판단에 필요한 최소 Sentinel 수

이 흐름을 이해하면
"왜 어떤 장애는 즉시 전환되고, 어떤 장애는 지연되는지"를 설명할 수 있습니다.

## 실습 관찰 포인트

```bash
redis-cli -p 6380 INFO replication
```

실무에서는 Sentinel 노드 수(보통 홀수)와 쿼럼 설정이 중요합니다.

단일 노드 Redis만으로는 Sentinel failover를 재현하기 어렵습니다.
따라서 이 장의 실습은 관찰 중심으로 두고,
실전 검증은 `3 Sentinel + Primary/Replica` 토폴로지에서 수행해야 합니다.

권장 검증 항목:

1. Primary 강제 중단 시 전환 시간 측정
2. 애플리케이션 재연결 성공 여부
3. 장애 중 쓰기/읽기 실패율 변화

## 설계 포인트

- Sentinel 자체도 다중 노드로 구성
- 네트워크 분할(split brain) 시나리오 고려
- 애플리케이션 클라이언트가 failover를 따라갈 수 있어야 함

추가 설계 포인트:

- Sentinel과 데이터 노드를 같은 장애 도메인에 몰지 않기
- 전환 중 읽기 일관성 정책(구 Primary 읽기 허용 여부) 명시
- 운영 알림에 "전환 발생" 이벤트를 별도 분류

## 자주 하는 실수

1. Replica를 백업처럼 오해
2. Sentinel 쿼럼을 임의로 낮게 설정
3. failover 테스트 없이 운영 진입
4. 클라이언트 재시도/재연결 타임아웃을 기본값에 방치
5. 장애 전환 SLA(몇 초 이내 복구)를 정의하지 않음

## 요약

- 복제는 읽기 확장과 고가용성의 기본 축이다.
- Sentinel은 장애 감지와 자동 전환의 제어면이다.
- 운영 안정성은 설정값보다 테스트 리허설이 만든다.

## 연습문제

### 기초

1. `INFO replication` 출력 항목을 해석해보세요.
2. Sentinel이 필요한 이유를 5줄로 작성해보세요.

### 응용

1. failover 시 애플리케이션 재연결 전략을 설계해보세요.
2. Sentinel 장애 시 대응 체크리스트를 작성해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [ ] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
