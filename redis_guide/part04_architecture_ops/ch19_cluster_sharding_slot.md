# Chapter 19 - Cluster, 샤딩, 해시 슬롯

- 상태: 초안 완료
- 목표 분량: 11쪽

## 학습 목표

- Redis Cluster의 해시 슬롯 구조를 이해한다.
- 샤딩 시 키 분산 전략을 설계할 수 있다.
- Cross-slot 제약을 설명할 수 있다.

## 핵심 개념

Redis Cluster는 키를 16384개 해시 슬롯으로 나누어 분산 저장합니다.
노드 확장 시 슬롯을 재배치해 수평 확장을 수행합니다.

이 구조의 핵심은 "노드 수"가 아니라 "슬롯 배치"입니다.
노드를 늘려도 슬롯 분포가 불균형하면 성능 문제가 계속됩니다.

또한 Cluster 환경에서는 다중 키 연산에 제약이 있습니다.
연산 대상 키가 서로 다른 슬롯에 있으면
일부 명령은 `CROSSSLOT` 오류가 발생합니다.

### 해시 태그

`user:{1001}:profile`, `user:{1001}:token` 처럼
중괄호 안 문자열이 같으면 같은 슬롯으로 매핑됩니다.

다중 키 연산이 필요한 경우 해시 태그 설계가 중요합니다.

예를 들어 사용자 단위 트랜잭션이 필요하면
`user:{userId}:profile`, `user:{userId}:token`처럼
같은 태그를 공유하게 설계해 슬롯 공존을 보장할 수 있습니다.

단, 모든 키를 한 태그에 몰면 핫스팟이 생기므로
"공존이 필요한 키만" 태그를 공유해야 합니다.

### 리샤딩(Re-sharding) 관점

클러스터 확장은 노드 추가로 끝나지 않습니다.
슬롯 이동 중에는 지연 변동, 일시적 재시도 증가가 나타날 수 있습니다.
그래서 리샤딩은 배포 이벤트처럼 계획적으로 수행해야 합니다.

최소 재현 실습(학습용):

1. 3-master 클러스터 구성
2. 키를 태그 없는 경우와 태그 있는 경우로 나눠 저장
3. 다중 키 연산 시 `CROSSSLOT` 발생 여부 비교
4. 리밸런싱 전후 p95와 오류율 비교

## 설계 포인트

- 핫키 분산과 관련 키 공존 요구를 함께 고려
- 키 패턴 변경 시 마이그레이션 계획 필요
- 클러스터 모드 클라이언트 설정 검증 필수

추가 설계 포인트:

- 키 설계 문서에 "해시 태그 사용 규칙"을 명시
- 슬롯/노드별 트래픽 분포 대시보드 운영
- 리샤딩 전후 p95, 오류율, 재시도율 비교 측정

## 자주 하는 실수

1. 다중 키 연산 요구를 무시하고 임의 키 생성
2. 일부 슬롯에 트래픽이 몰리는 키 설계
3. 클러스터 리밸런싱 영향 분석 없이 배포
4. 클러스터 모드 미지원 클라이언트 설정으로 운영 진입
5. 키 태그 정책 없이 팀마다 다른 방식으로 키 생성

## 요약

- Cluster는 대용량/고처리량 환경의 핵심 확장 방식이다.
- 슬롯 이해와 키 설계가 성능과 안정성을 결정한다.

## 연습문제

### 기초

1. 해시 태그가 필요한 이유를 설명해보세요.
2. 슬롯 분산이 불균형할 때의 위험을 적어보세요.

### 응용

1. 사용자 도메인 키를 클러스터 친화적으로 재설계해보세요.
2. 리샤딩 작업 전 체크리스트를 작성해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [ ] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
