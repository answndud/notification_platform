# Chapter 12 - 원자성과 트랜잭션

- 상태: 초안 완료
- 목표 분량: 11쪽

## 학습 목표

- Redis 원자성의 의미를 이해할 수 있다.
- `MULTI/EXEC/WATCH` 흐름을 설명할 수 있다.
- 낙관적 잠금 기반 충돌 처리 패턴을 설계할 수 있다.

## 핵심 개념

Redis는 단일 스레드 이벤트 루프 기반으로 명령을 순차 처리합니다.
이 특성 덕분에 단일 명령은 원자적으로 실행됩니다.

여기서 중요한 구분이 있습니다.

- 단일 명령 원자성: Redis가 기본 제공
- 비즈니스 로직 원자성: 애플리케이션이 별도 설계해야 함

예를 들어 "재고 차감 + 주문 생성"은 두 저장소를 걸치면
Redis 명령 원자성만으로는 완전한 일관성을 보장할 수 없습니다.

여러 명령을 묶어 처리하려면 트랜잭션 기능을 사용합니다.

주요 명령:

- `MULTI`: 트랜잭션 시작
- `EXEC`: 큐에 쌓인 명령 실행
- `DISCARD`: 취소
- `WATCH`: 특정 키 변경 감시

## WATCH 기반 낙관적 잠금

`WATCH`는 "내가 읽은 값이 바뀌지 않았으면 커밋" 전략입니다.
경쟁이 발생하면 `EXEC`가 실패하며, 애플리케이션이 재시도해야 합니다.

재시도 설계 시 필수 항목:

- 최대 재시도 횟수
- 백오프 간격
- 최종 실패 시 사용자/호출자 응답 규약

## 실습 예제

```bash
redis-cli -p 6380 SET balance:user:1 100
redis-cli -p 6380 WATCH balance:user:1
redis-cli -p 6380 MULTI
redis-cli -p 6380 DECRBY balance:user:1 10
redis-cli -p 6380 EXEC
```

## 설계 포인트

- 단일 키 갱신이면 단일 명령으로 해결하는 것이 가장 안전
- 다중 단계 갱신은 Lua 스크립트와 비교 검토
- 충돌 재시도 횟수와 실패 응답 규칙을 명확히 정의

트랜잭션 선택 기준:

1. 단순 카운터/플래그 -> 단일 명령 우선
2. 다중 키 조건부 갱신 -> WATCH 검토
3. 다단계 원자 처리 + RTT 절감 -> Lua/Functions 검토

## 자주 하는 실수

1. 트랜잭션이 RDBMS ACID와 완전히 같다고 오해
2. `WATCH` 실패 시 재시도 로직을 누락
3. 긴 비즈니스 로직을 트랜잭션 큐 안에 과도하게 포함

## 요약

- Redis 단일 명령은 원자적이다.
- 복합 갱신은 `MULTI/EXEC` 또는 스크립트로 제어한다.
- 충돌 처리 정책이 없으면 일관성 이슈가 발생한다.

## 연습문제

### 기초

1. `MULTI`/`EXEC` 기본 예제를 직접 실행해보세요.
2. `WATCH` 충돌 시나리오를 만들어보세요.

### 응용

1. 재고 차감 로직을 낙관적 잠금으로 설계해보세요.
2. 트랜잭션 실패 응답 정책을 API 관점에서 작성해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [x] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
