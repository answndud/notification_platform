# Chapter 24 - HotKey와 Thundering Herd

- 상태: 초안 완료
- 목표 분량: 9쪽

## 학습 목표

- HotKey와 캐시 스탬피드(Thundering Herd) 현상을 이해할 수 있다.
- 탐지 지표와 완화 전략을 적용할 수 있다.
- 대량 만료 시나리오를 안전하게 설계할 수 있다.

## 핵심 개념

### HotKey

특정 키에 트래픽이 과도하게 집중되는 현상입니다.

핫키는 캐시 hit율이 높아도 장애를 만들 수 있습니다.
문제는 "총 트래픽"이 아니라 "단일 키 집중도"입니다.

### Thundering Herd

많은 키가 동시에 만료되어 DB로 요청이 폭주하는 현상입니다.

주로 배치 캐시 적재나 고정 TTL(예: 모두 300초) 설정에서 발생합니다.
증상은 DB CPU 급등, API p95 급등, 타임아웃 증가로 나타납니다.

### 두 현상의 차이

- HotKey: 특정 소수 키 집중
- Herd: 대량 키 동시 만료로 광범위 미스

대응 전략이 다르므로 원인 구분이 먼저입니다.

## 완화 전략

- TTL 랜덤 지터(jitter) 적용
- 로컬 캐시 + Redis 2단 캐시
- 요청 병합(single flight)
- 인기 키 사전 워밍
- 읽기 부하 분산

보강 전략:

- stale-while-revalidate 패턴
- 인기 키 precompute 스케줄링
- 키 분할(예: 지역/세그먼트 단위)

## 설계 포인트

- 만료 시간을 동일 시각에 맞추지 않기
- 상위 트래픽 키를 별도 모니터링
- 장애 시 캐시 우회 정책을 신중히 정의

운영 지표 권장:

- 상위 키별 QPS
- 캐시 miss burst 비율
- 원본 DB fallback 요청량
- single flight 성공/대기 비율

## 자주 하는 실수

1. 모든 키 TTL을 동일하게 설정
2. 핫키를 발견해도 구조 개선 없이 인프라만 증설
3. 캐시 미스 폭주 테스트를 수행하지 않음
4. 장애 시 fallback이 DB를 더 무너뜨리는 구조를 방치

## 요약

- HotKey와 스탬피드는 예측 가능한 장애 패턴이다.
- TTL 분산과 요청 병합만으로도 큰 폭의 안정화가 가능하다.

## 연습문제

### 기초

1. HotKey 탐지용 지표 3개를 제시해보세요.
2. TTL 지터 전략의 예시를 작성해보세요.

### 응용

1. 캐시 미스 폭주 대응 런북을 작성해보세요.
2. 인기 API에 single flight를 적용하는 설계를 작성해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [ ] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
