# Chapter 23 - 캐시 무효화 전략

- 상태: 초안 완료
- 목표 분량: 9쪽

## 학습 목표

- TTL 기반과 이벤트 기반 무효화를 구분할 수 있다.
- 데이터 일관성 요구에 맞춰 무효화 전략을 설계할 수 있다.
- 무효화 실패 시 대응 방안을 마련할 수 있다.

## 핵심 개념

캐시의 본질적 난제는 "언제 지울 것인가"입니다.
무효화가 늦으면 오래된 데이터가 노출되고,
너무 공격적이면 캐시 효율이 떨어집니다.

무효화는 성능 문제가 아니라 "정합성 계약" 문제입니다.
사용자에게 어떤 시점의 데이터를 보여줘도 되는지,
도메인별 허용 오차를 먼저 정해야 합니다.

예를 들어 상품 소개 문구는 수분 단위 지연 허용 가능하지만,
재고/가격은 수초 지연도 문제가 될 수 있습니다.

## 대표 전략

1. TTL 기반
- 단순하고 안전하지만 실시간 일관성은 약함

2. 이벤트 기반 삭제
- 쓰기 이벤트 시 관련 키 즉시 삭제
- 일관성은 좋지만 구현 복잡도 증가

3. 버전 키 전략
- 데이터 버전을 키에 반영하여 자연 교체

4. Soft TTL + Background Refresh
- 응답은 기존 캐시를 우선 사용하되,
- 백그라운드에서 갱신을 트리거해 사용자 지연을 줄임

### 전략 조합이 필요한 이유

실무에서는 단일 전략으로 모든 요구를 만족시키기 어렵습니다.
그래서 보통 아래 조합을 사용합니다.

- 일반 조회: TTL 기반
- 중요 변경 이벤트: 즉시 무효화
- 장애 대비: TTL 안전망 유지

## 설계 포인트

- 중요 데이터는 이벤트 무효화 + TTL 이중 안전장치 권장
- 키 관계 맵(어떤 변경이 어떤 키를 지우는가) 문서화
- 무효화 실패 시 재시도 큐 또는 보정 배치 설계

추가 설계 포인트:

- 무효화 이벤트에 idempotency 키 적용
- 키 팬아웃이 큰 경우 태그/인덱스 키로 삭제 범위 관리
- 대량 무효화 시 트래픽 스파이크 완화 전략 준비

## 자주 하는 실수

1. TTL 하나로 모든 일관성 요구를 해결하려고 시도
2. 연관 키 삭제 범위를 누락
3. 무효화 로직 테스트 부재
4. 무효화 실패를 관측할 지표가 없음

## 요약

- 무효화는 캐시 설계의 핵심이다.
- 단순성(TTL)과 정확성(이벤트)의 균형이 중요하다.

## 연습문제

### 기초

1. TTL 무효화의 장단점을 적어보세요.
2. 이벤트 무효화 흐름을 의사코드로 작성해보세요.

### 응용

1. 상품 가격 변경 시 삭제해야 할 캐시 키 목록을 설계해보세요.
2. 무효화 실패 탐지용 지표를 제안해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [ ] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
