# Chapter 04 - 키 설계 원칙

- 상태: 초안 완료
- 목표 분량: 10쪽

## 학습 목표

- 키 네이밍 규칙을 일관되게 설계할 수 있다.
- 충돌 없는 네임스페이스 전략을 수립할 수 있다.
- 마이그레이션을 고려한 키 버전 전략을 적용할 수 있다.

## 핵심 개념

Redis 성능 문제의 시작점은 자료구조보다 키 설계인 경우가 많습니다.
키 이름이 모호하면 운영, 장애 대응, 데이터 정리가 모두 어려워집니다.

키 설계를 파일 경로처럼 생각하면 이해가 쉽습니다.
좋은 파일 경로는 목적과 위치를 설명하고,
좋은 Redis 키도 도메인과 대상을 설명해야 합니다.

권장 기본 형식:

`도메인:엔티티:식별자[:세부식별자][:v버전]`

이 형식의 장점은 세 가지입니다.

1. 검색 가능성
- 운영 중 `SCAN MATCH auth:*`처럼 범위 점검이 쉬움

2. 정책 연결
- `auth:*` 키군에 공통 TTL/보안 정책 적용 가능

3. 마이그레이션 용이성
- 버전을 키로 구분해 점진 전환 가능

예시:

- `auth:refresh:user:1024`
- `cache:product:981:v2`
- `rate:login:ip:10.10.0.2`

## 좋은 키 설계의 기준

1. 읽기만으로 의미가 드러나는가
2. 운영자가 패턴을 쉽게 추적할 수 있는가
3. TTL 정책을 키 그룹 단위로 관리할 수 있는가
4. 버전 업 시 충돌 없이 공존 가능한가

5. 개인정보/민감정보 노출이 없는가
- 이메일 원문, 전화번호 원문을 키에 그대로 넣는 것은 피해야 함

6. 길이가 과도하지 않은가
- 너무 긴 키는 메모리 비용과 가독성 모두에 불리

## 네임스페이스 전략

- 서비스 단위 접두사: `np:` 같은 프리픽스
- 도메인 단위 구분: `auth`, `cache`, `metric`
- 환경 단위 분리: 필요 시 `dev`, `stg`, `prod` 분리

환경 분리는 물리 인스턴스 분리가 최우선이며,
키 이름 분리는 보조 수단으로 사용합니다.

추가로, 다중 서비스가 같은 Redis를 공유하면
서비스 식별자 접두사를 강제해야 충돌을 줄일 수 있습니다.
예: `np:auth:refresh:user:1`

## 버전 전략

스키마 변경이 필요한 경우 키 버전을 함께 사용합니다.

예시:

- 이전: `cache:user:42`
- 신규: `cache:user:42:v2`

장점:

- 무중단 전환이 쉬움
- 롤백 시 영향 범위 축소

주의점:

- v1/v2 병행 기간을 명시하지 않으면 "영구 이중 운영" 상태가 됨
- 전환 완료 후 구버전 키 정리 시점을 체크리스트로 관리해야 함

## 실습 예제

### 예제 A: 키 규칙 시뮬레이션

```bash
redis-cli -p 6380 SET auth:refresh:user:1 token1 EX 1200
redis-cli -p 6380 SET cache:product:10:v1 '{"name":"pen"}' EX 300
redis-cli -p 6380 SET cache:product:10:v2 '{"name":"pen","price":1000}' EX 300
```

관찰 포인트:
- 도메인별 구분이 직관적인지
- 버전 공존이 가능한지

### 예제 B: 안전한 조회

```bash
redis-cli -p 6380 SCAN 0 MATCH cache:product:* COUNT 100
```

관찰 포인트:
- 운영 환경에서 `KEYS` 대신 `SCAN` 사용

## 설계 포인트

- 키 길이는 가독성과 메모리 비용의 균형을 잡아야 함
- 식별자에는 사용자 입력 원문 대신 정규화된 값 사용
- 키 규칙 문서는 코드와 같은 수준으로 변경 이력 관리

권장 운영 규칙:

- 신규 키 추가 PR에는 "키 규칙 표" 업데이트를 필수화
- 키 규칙 위반을 방지하는 리뷰 체크리스트 운영

## 자주 하는 실수

1. 팀마다 다른 키 포맷을 사용해 충돌 발생
2. 키 이름에 의미 없는 약어만 사용
3. 버전 없이 스키마를 변경해 파싱 오류 발생

## 요약

- 키 설계는 Redis 운영 품질의 핵심이다.
- 네임스페이스, 버전, 의미 전달성을 표준으로 고정해야 한다.
- `SCAN` 기반 운영 습관과 문서화가 장기 안정성을 만든다.

## 연습문제

### 기초

1. 본인 서비스 기준으로 키 네이밍 규칙 초안을 작성해보세요.
2. 버전이 필요한 상황을 2가지 적어보세요.

### 응용

1. 기존 키 체계를 v2 체계로 옮기는 절차를 단계별로 적어보세요.
2. 키 충돌 사고가 났을 때의 원인 분석 항목을 설계해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [x] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
