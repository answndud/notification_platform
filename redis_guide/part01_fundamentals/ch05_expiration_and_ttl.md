# Chapter 05 - 만료 정책과 TTL

- 상태: 초안 완료
- 목표 분량: 10쪽

## 학습 목표

- TTL(Time To Live)의 개념과 동작을 이해할 수 있다.
- 데이터 수명에 맞는 만료 정책을 설계할 수 있다.
- TTL 누락/불일치로 인한 운영 문제를 예방할 수 있다.

## 핵심 개념

TTL은 키의 생존 시간을 뜻합니다.
Redis는 TTL이 끝난 키를 자동으로 제거해 메모리와 데이터 수명을 관리합니다.

TTL은 단순 옵션이 아니라 데이터 계약입니다.
"이 데이터는 언제까지 유효한가"를 코드로 명시하는 행위입니다.

그래서 TTL 설계가 약하면, 기능은 동작해도 운영 품질이 무너집니다.

TTL이 필요한 대표 데이터:

- 세션
- 리프레시 토큰
- 캐시 결과
- 임시 레이트 리밋 카운터

TTL이 필요 없는 대표 데이터도 있습니다.

- 장기 기준 정보(단, Redis를 원본 저장소로 쓰는 경우는 제한적)
- 배치성 기준값 중 수동 갱신 대상

핵심은 "모든 키에 TTL"이 아니라 "수명 정의가 필요한 키에 의도적 TTL"입니다.

## TTL 명령 기본

- `EXPIRE key seconds`
- `TTL key`
- `PERSIST key` (만료 해제)
- `SET key value EX seconds` (저장과 만료를 동시에)

## TTL 설계 원칙

1. 비즈니스 수명과 일치시켜라
- 토큰은 보안 정책에 맞춘 수명
- 캐시는 데이터 갱신 주기와 일치

2. 저장과 TTL을 분리하지 말아라
- `SET` 후 `EXPIRE`를 따로 하면 누락 가능성이 증가
- 가능하면 원자적으로 한 번에 설정

3. 관찰 가능한 정책으로 운영하라
- 키군별 TTL 기준을 문서화
- 이상치(너무 긴 TTL, 무기한 키) 감시

4. 수명 기반으로 키군을 분리하라
- 5분 캐시와 7일 토큰을 같은 네임스페이스에 섞으면 운영 추적이 어려움

5. 만료와 무효화의 역할을 구분하라
- TTL: 시간 기반 자연 만료
- 무효화: 이벤트 기반 즉시 만료

## 실습 예제

### 예제 A: 원자적 TTL 설정

```bash
redis-cli -p 6380 SET auth:refresh:user:7 token EX 1200
redis-cli -p 6380 TTL auth:refresh:user:7
```

### 예제 B: TTL 누락 확인

```bash
redis-cli -p 6380 SET auth:refresh:user:8 token
redis-cli -p 6380 TTL auth:refresh:user:8
```

관찰 포인트:
- TTL 값이 `-1`이면 만료 없음
- 임시 데이터에 `-1`이 나오면 설계 점검 필요

## 설계 포인트

- 키 유형별 표준 TTL 테이블을 먼저 만든다.
- 보안 데이터는 "최대 수명"을 넘지 않게 강제한다.
- 무효화 이벤트가 있는 경우 TTL과 이벤트 삭제를 함께 설계한다.

실무 권장 표준(예시):

- `auth:access:*` -> 10~30분
- `auth:refresh:*` -> 7~14일
- `cache:product:*` -> 1~10분(데이터 특성별 차등)
- `rate:*` -> 정책 윈도우와 동일

이 표준은 서비스 정책, 보안 요구, 트래픽 패턴에 따라 조정합니다.

## 자주 하는 실수

1. TTL을 경로마다 다르게 적용해 정책 불일치 발생
2. 밀리초/초 단위 혼동으로 과도한 만료 또는 무기한 보관 발생
3. 삭제 이벤트만 믿고 TTL을 생략

## 요약

- TTL은 Redis 운영 안정성의 핵심 장치다.
- 임시 데이터는 저장 시점에 TTL을 원자적으로 설정해야 한다.
- TTL 정책은 문서화와 모니터링으로 유지해야 한다.

## 연습문제

### 기초

1. `EXPIRE`와 `SET ... EX`의 차이를 설명해보세요.
2. `TTL == -1`이 의미하는 바를 적어보세요.

### 응용

1. 세션/토큰/캐시 TTL 표준안을 작성해보세요.
2. TTL 누락을 CI에서 잡아내는 테스트 아이디어를 제시해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [x] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
