# Chapter 03 - 메모리 모델과 영속성 개요

- 상태: 초안 완료
- 목표 분량: 10쪽

## 학습 목표

- Redis 메모리 중심 구조의 장단점을 설명할 수 있다.
- RDB와 AOF의 차이를 개념적으로 구분할 수 있다.
- 내구성과 성능 사이의 기본 트레이드오프를 이해할 수 있다.

## 핵심 개념

Redis는 기본적으로 메모리에서 데이터를 처리합니다.
그래서 빠르지만, 프로세스 장애나 서버 장애가 나면 데이터 손실 위험이 생깁니다.

이 위험을 줄이기 위해 Redis는 영속성(persistence) 옵션을 제공합니다.
대표적으로 RDB와 AOF가 있습니다.

### 메모리 모델을 이해해야 하는 이유

초보자가 가장 자주 하는 오해는 "Redis에 넣었으니 저장됐다"는 가정입니다.
하지만 Redis에서 "저장"은 두 층으로 나뉩니다.

1. 메모리 반영
- 명령이 성공하면 우선 메모리 상태가 바뀝니다.

2. 디스크 반영
- 영속성 정책에 따라 나중에 파일로 기록됩니다.

이 두 단계 사이의 간격이 곧 데이터 유실 가능 구간입니다.
따라서 내구성 설계는 "평소 성능"이 아니라 "사고 시 손실" 기준으로 해야 합니다.

### Redis 메모리 동작의 실무 포인트

- Redis는 키/값 자체 외에도 메타데이터 오버헤드가 있습니다.
- 작은 키를 매우 많이 저장하면 예상보다 메모리 사용량이 커집니다.
- 만료 키는 즉시 전량 삭제가 아니라, 접근 시 제거 + 백그라운드 정리의 조합으로 처리됩니다.

즉, 메모리는 단순 합산이 아니라 "구조 + 개수 + TTL 패턴"으로 봐야 합니다.

### RDB 스냅샷

- 특정 시점의 메모리 상태를 파일로 저장
- 장점: 파일이 비교적 작고 복구가 빠른 편
- 단점: 스냅샷 사이 구간 데이터는 유실 가능

RDB는 "시점 백업"에 가깝습니다.
예를 들어 5분마다 스냅샷이면, 장애 시 최대 5분 데이터 유실을 받아들여야 합니다.

### AOF(Append Only File)

- 쓰기 명령을 로그처럼 계속 기록
- 장점: 더 촘촘한 복구 가능
- 단점: 파일 크기 증가, 재작성(rewrite) 관리 필요

AOF는 "기록 기반 복구"에 가깝습니다.
설정에 따라 1초 단위 손실로 줄일 수 있지만, 그만큼 쓰기 비용이 증가할 수 있습니다.

### RDB + AOF 조합 전략

실무에서는 둘 중 하나만 고정하기보다 조합을 씁니다.

- RDB: 빠른 전체 복구 기반
- AOF: 최근 변경 내역 보전 강화

이 조합은 복구 속도와 데이터 보전의 균형을 맞추는 데 유리합니다.

## 내구성 선택의 기본 원칙

1. 데이터가 재생성 가능한가?
- 캐시 데이터라면 일부 유실 허용 범위가 큼

2. 유실 허용 시간이 얼마인가?
- 초 단위 허용인지, 거의 0초를 원하는지 판단

3. 쓰기 성능 우선인가, 복구 정밀도 우선인가?
- 둘을 동시에 극단적으로 잡기 어렵다는 점을 인정해야 함

### 의사결정 예시

- 시나리오 A: 상품 목록 캐시
  - 일부 유실 허용 가능 -> RDB 중심으로도 충분

- 시나리오 B: 로그인 refresh 토큰
  - 유실 시 사용자 영향 큼 -> AOF 병행 + TTL 정책 엄격화 권장

## 실습 예제

### 예제 A: 현재 영속성 설정 확인

```bash
redis-cli -p 6380 INFO persistence
```

관찰 포인트:
- RDB/AOF 활성화 여부
- 마지막 저장 시점
- rewrite 진행 여부

### 예제 B: AOF 활성 환경에서 쓰기 후 확인

```bash
redis-cli -p 6380 SET demo:persist v1
redis-cli -p 6380 GET demo:persist
```

관찰 포인트:
- 즉시 조회 가능 여부
- 재시작 후 데이터 유지 여부(환경 설정에 따라 달라짐)

## 설계 포인트

- 캐시 전용이면 RDB 중심, 토큰/세션 등 중요 임시 데이터면 AOF 병행 고려
- 저장 정책은 서비스 SLA와 함께 문서화
- 운영 환경에서는 백업/복구 리허설을 반드시 주기적으로 수행

추가 점검 항목:

- 장애 복구 후 데이터 정합성 검증 쿼리 준비
- AOF 파일 증가율과 rewrite 주기 관측
- 환경별 설정 차이(dev/stg/prod) 문서화

## 자주 하는 실수

1. "Redis는 메모리니까 영속성은 필요 없다"고 단정
2. 영속성 옵션을 켰지만 복구 테스트를 하지 않음
3. 파일 증가와 rewrite 부하를 모니터링하지 않음

## 요약

- Redis는 빠르지만 메모리 중심이라 손실 위험이 존재한다.
- RDB는 시점 저장, AOF는 명령 로그 저장 방식이다.
- 영속성 정책은 성능, 복구 목표, 데이터 성격을 함께 보고 결정해야 한다.

## 연습문제

### 기초

1. RDB와 AOF의 차이를 3줄로 비교해보세요.
2. 캐시 데이터에 과도한 내구성이 꼭 필요한지 의견을 적어보세요.

### 응용

1. 본인 서비스 데이터를 "유실 허용"/"유실 비허용"으로 분류해보세요.
2. Redis 장애 후 복구 점검 체크리스트 5개를 작성해보세요.

## 챕터 체크리스트

- [x] 초안 작성 완료
- [x] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
