# Chapter 28 - 이벤트 계약과 버전 관리

- 상태: 초안 완료
- 목표 분량: 8쪽

## 학습 목표
- 이벤트 계약과 버전 전략을 설계할 수 있다.
- 호환성 정책을 적용할 수 있다.
- 무중단 스키마 변경 절차를 정리할 수 있다.

## 핵심 개념

이벤트 계약은 producer와 consumer의 공동 API입니다.
버전 전략이 없으면 변경 때마다 서비스 간 충돌이 발생합니다.

## 실습 예제

실습 목적: backward compatibility를 유지하며 v1에서 v2로 단계 전환하는 절차를 익힙니다.

```text
v1 필드 유지 + v2 선택 필드 추가 -> 소비자 단계적 업그레이드 -> 구버전 정리
```

예상 결과/관찰 포인트:
- 기존 소비자가 깨지지 않은 상태에서 신규 필드를 점진 도입할 수 있습니다.
- producer 선배포 전 소비자 호환성 확인이 필수임을 확인합니다.
- 버전 공존 기간이 길어지면 운영 복잡도가 증가함을 확인합니다.

## 실패 시 확인 항목

1. 호환성 위반 변경
- 증상: 일부 소비자 파싱 실패, 처리 중단
- 확인: 필수 필드 삭제/타입 변경 여부 점검

2. 배포 순서 오류
- 증상: producer 배포 직후 소비자 오류 급증
- 확인: 소비자 대응 버전 선배포 여부 점검

3. 계약 문서 누락
- 증상: 팀별 이벤트 해석 불일치
- 확인: 이벤트 스키마/샘플/버전 정책 동기화 여부 점검

## 설계 포인트
- backward compatibility를 기본 원칙으로 둔다.
- 이벤트 문서/샘플/테스트를 버전별 관리한다.
- 배포 순서를 producer/consumer 영향도 기준으로 조정한다.

운영 반영 체크리스트:
- 버전별 필드 변경 이력과 마이그레이션 종료일 기록
- 계약 위반 탐지 테스트를 CI에 고정
- 구버전 삭제 전 소비율/오류율 확인 후 단계적 정리

## 자주 하는 실수
1. 필수 필드를 갑자기 변경
2. 버전 태깅/문서화 누락
3. 소비자 준비 이전 producer 선배포

## 요약
- 이벤트 계약은 조직 간 약속이다.
- 버전 정책이 있어야 무중단 변경이 가능하다.

## 연습문제
### 기초
1. 이벤트 버전 정책 원칙 3개를 적어보세요.
2. 하위 호환 예시를 작성해보세요.

### 응용
1. v1->v2 전환 체크리스트를 작성해보세요.
2. 계약 위반 탐지 테스트를 설계해보세요.

## 예제 명령어 검증 시나리오(권장)

사전 조건:
- Python 3 실행 가능

검증 절차:
1. `./scripts/verify_kafka_contract_compat.sh` 실행
2. v1/v2 페이로드에서 v1 필수 필드 유지 여부 확인

성공 기준:
- v1/v2 JSON 출력과 함께 PASS 메시지 확인
- v2에 선택 필드가 추가되어도 v1 필수 필드 검증이 통과함

## 챕터 체크리스트
- [x] 초안 작성 완료
- [x] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [x] 최종 교정 완료
