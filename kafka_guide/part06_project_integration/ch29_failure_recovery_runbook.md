# Chapter 29 - 장애 대응/복구 런북

- 상태: 초안 완료
- 목표 분량: 8쪽

## 학습 목표
- Kafka 장애 대응 우선순위를 정할 수 있다.
- 영향도 분석/커뮤니케이션 기준을 수립할 수 있다.
- 복구 후 재발 방지 절차를 정리할 수 있다.

## 핵심 개념

런북은 문서가 아니라 실행 순서입니다.
장애 중에는 "원인 완전 분석"보다 "서비스 완화"가 먼저입니다.

## 표준 대응 절차
1. 감지: lag/오류율/지연 이상 탐지
2. 영향 파악: 핵심 토픽/컨슈머 영향 범위 식별
3. 완화: 트래픽 제한/재시도 정책 조정
4. 복구: 브로커/컨슈머 정상화
5. 검증: 핵심 이벤트 흐름 복원 확인
6. 회고: 재발 방지책 문서화

## 장애 등급과 에스컬레이션

| 등급 | 기준(예시) | 에스컬레이션 |
|---|---|---|
| Sev1 | 핵심 이벤트 처리 중단, 데이터 정합성 위험 | 5분 내 리더/플랫폼 호출 |
| Sev2 | 처리 지연 증가, 우회 가능 | 15분 내 담당 팀 공유 |

권장 타이머:
- 감지 후 3분 내 첫 상태 공유
- 10분 내 완화 전략 확정
- 30분 단위 진행 상황 업데이트

## 복구 완료 선언 기준(DoD)

1. 지표 정상화
- consumer lag가 15분 연속 감소 또는 정상 범위 유지

2. 기능 정상화
- 핵심 API 성공률/지연이 기준치 복귀

3. 데이터 정합성 확인
- 샘플 이벤트 재처리 결과와 원본 데이터 일치

4. 커뮤니케이션 완료
- 내부/외부 상태 공지와 다음 액션 공유

## 커뮤니케이션 템플릿

초기 공지(내부):
```text
[Sev2][Kafka] 결제 이벤트 처리 지연 감지
- 영향: 일부 알림 발송 지연
- 현재 조치: 소비자 증설 + 외부 API timeout 점검
- 다음 업데이트: 10분 후
```

복구 공지(내부/운영):
```text
[복구 완료][Kafka] 결제 이벤트 지연 정상화
- 복구 시각: 14:35
- 검증: lag 정상 범위 복귀, 핵심 API 성공률 정상
- 후속: 원인 분석 및 재발 방지안 D+1 공유
```

## 설계 포인트
- 장애 등급(Sev1/Sev2)과 에스컬레이션 조건을 명시한다.
- 상태 공유 템플릿(내부/사용자)을 미리 준비한다.
- 드릴(모의훈련)을 정기 운영한다.

## 자주 하는 실수
1. 완화보다 원인 추적에만 집중
2. 복구 후 검증 생략
3. 회고/문서 업데이트 누락

## 요약
- 장애 대응의 핵심은 속도와 일관성이다.
- 감지-완화-복구-회고 루틴을 고정해야 한다.

## 연습문제
### 기초
1. 장애 대응 1페이지 런북을 작성해보세요.
2. 필수 알림 지표를 3개 선정해보세요.

### 응용
1. 온콜 드릴 시나리오를 설계해보세요.
2. 복구 완료 판정 기준을 수치로 작성해보세요.

## 예제 명령어 검증 시나리오(권장)

사전 조건:
- 온콜 드릴 참여자(지휘/분석/커뮤니케이션 역할) 지정
- lag/오류율 대시보드와 공지 채널 준비

검증 절차:
1. 가상 장애 주입(소비자 중단 또는 외부 의존 timeout 증가)
2. 3분 내 첫 상태 공유, 10분 내 완화 전략 발표
3. 복구 후 DoD(지표/기능/정합성/공지) 체크
4. D+1 회고 문서와 재발 방지 항목 등록

성공 기준:
- 초기 공유/완화/복구 타임라인이 목표 시간 내 달성
- 복구 완료 선언이 수치 기준에 의해 결정됨
- 회고 결과가 런북/알림 정책 변경으로 연결됨

## 챕터 체크리스트
- [x] 초안 작성 완료
- [ ] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [ ] 최종 교정 완료
