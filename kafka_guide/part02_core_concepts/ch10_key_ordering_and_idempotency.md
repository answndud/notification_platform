# Chapter 10 - Key 정렬성과 Idempotency

- 상태: 초안 완료
- 목표 분량: 11쪽

## 학습 목표
- 파티션 키와 순서 보장 관계를 설명할 수 있다.
- 중복 처리 방지 전략을 설계할 수 있다.
- idempotent 처리 규칙을 도메인에 적용할 수 있다.

## 핵심 개념

Kafka의 순서 보장은 파티션 단위입니다.
같은 키를 쓰면 같은 파티션으로 가므로 상대적으로 순서 유지가 쉽습니다.

Idempotency는 같은 이벤트를 여러 번 처리해도 결과가 같게 만드는 성질입니다.
실무에서는 "중복이 온다"를 기본 전제로 설계해야 안전합니다.

## 직관 그림

```text
key=userA -> Partition 1 -> offset 10,11,12 ... (순서 보장)
key=userB -> Partition 0 -> offset 20,21,22 ... (순서 보장)

전체 토픽 기준 전역 순서 보장은 아님
```

```text
중복 이벤트 도착
  eventId=e100
  eventId=e100

idempotent 소비자:
  처리 이력(e100) 존재 -> 2번째 이벤트는 무시
```

## 실습 예제

```bash
# producer에서 동일 key를 반복 전송하는 시나리오를 가정하고
# consumer에서 eventId 기준 중복 제거 로그를 남긴다.
```

## 설계 포인트
- eventId/idempotency key를 명시적으로 포함한다.
- DB upsert/중복 테이블/락 전략 중 하나를 표준화한다.
- 순서 요구가 높은 이벤트는 키 전략을 문서화한다.

## 자주 하는 실수
1. 키 전략 없이 순서 보장을 기대
2. 중복 제거 기준이 없음
3. idempotency 저장소 만료 정책 미정의

## 요약
- 순서는 파티션 단위, 중복은 항상 발생 가능하다.
- 키와 idempotency는 세트로 설계해야 한다.

## 초보자 체크
- 왜 "같은 키"를 써야 순서가 맞기 쉬운지 설명할 수 있는가?
- eventId 기반 중복 제거 로직을 의사코드로 작성할 수 있는가?

## 연습문제
### 기초
1. 같은 키를 쓰는 이유를 설명해보세요.
2. idempotent 처리 예시를 1개 작성해보세요.

### 응용
1. 주문 생성 이벤트 중복 처리 설계를 작성해보세요.
2. idempotency key TTL 정책을 제안해보세요.

## 챕터 체크리스트
- [x] 초안 작성 완료
- [x] 예제 명령어 검증 완료
- [x] 초보자 기준 용어 설명 완료
- [ ] 최종 교정 완료
